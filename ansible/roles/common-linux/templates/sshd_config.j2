# {{ ansible_managed }}
# Crucible SSH Server Configuration â€” Hardened Baseline
# See: ansible/roles/common-linux/defaults/main.yml for tunable values

Port {{ sshd_port }}
AddressFamily inet
ListenAddress 0.0.0.0

# Authentication
PermitRootLogin {{ sshd_permit_root_login }}
PubkeyAuthentication {{ sshd_pubkey_authentication }}
PasswordAuthentication {{ sshd_password_authentication }}
PermitEmptyPasswords {{ sshd_permit_empty_passwords }}
ChallengeResponseAuthentication no
MaxAuthTries {{ sshd_max_auth_tries }}
AuthenticationMethods publickey

# Session
ClientAliveInterval {{ sshd_client_alive_interval }}
ClientAliveCountMax {{ sshd_client_alive_count_max }}
LoginGraceTime 30
MaxSessions 3

# Forwarding
X11Forwarding {{ sshd_x11_forwarding }}
AllowAgentForwarding {{ sshd_allow_agent_forwarding }}
AllowTcpForwarding {{ sshd_allow_tcp_forwarding }}

# Access control
{% if sshd_allowed_users | length > 0 %}
AllowUsers {{ sshd_allowed_users | join(' ') }}
{% endif %}

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Security
StrictModes yes
IgnoreRhosts yes
HostbasedAuthentication no
UsePAM yes
PrintMotd yes
PrintLastLog yes

# Banner
Banner /etc/ssh/crucible-banner

# Subsystem
Subsystem sftp /usr/lib/openssh/sftp-server

# Key exchange and cipher hardening
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256
